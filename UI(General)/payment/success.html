<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- External CSS styling -->
    <link rel="stylesheet" href="../css/view_delivery.css">

    <!--CSS Template-->
    <!-- <link rel="stylesheet" type="text/css" href="css-template.css" /> -->

    <!--Import Rubik font-->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik&display=swap');
    </style>

    <!--Import Roboto font-->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
    </style>

    <!--Import Patua One font-->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Patua+One&display=swap');
    </style>

    <!-- JQuery  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

    <!--Animate.js CDN-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <title>Thanks for your order!</title>

    <style>
    /* Center the loader */
    #loader {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 1;
        width: 120px;
        height: 120px;
        margin: -76px 0 0 -76px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #CEA68C;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
    }
    
    @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Add animation to "page content" */
    /* .animate-bottom {
        position: relative;
        -webkit-animation-name: animatebottom;
        -webkit-animation-duration: 1s;
        animation-name: animatebottom;
        animation-duration: 5s
    } */
    
    /* @-webkit-keyframes animatebottom {
        from { bottom:-100px; opacity:0 } 
        to { bottom:0px; opacity:1 }
    }
    
    @keyframes animatebottom { 
        from{ bottom:-100px; opacity:0 } 
        to{ bottom:0; opacity:1 }
    } */ 
    
    #myDiv {
        display: none;
        text-align: center;
    }
    </style>
</head>
<body>
    <header> 
        <img class="logo" src="../images/logo.jpg" width='80px;' height='40px;' alt="logo">
        <nav>
            <ul class="nav__links">
                <li><a href="customer/customer_home.html">Home</a></li>
                <li><a href="../customer_view_delivery_details.html">View Deliveries</a></li>
                <li><a href="customer/delivery_order.html">Add New Delivery</a></li>
                <li><a href="customer/profile.html">Profile</a></li>
            </ul>
        </nav>
        <a class="LogOut" href="landing.html"><button class='btn'>Log Out</button></a>
    </header>
    
    <div class="container-fluid" id='app'>
        <!-- <div class="alert alert-success" role="alert">
            The payment made was successful!
        </div> -->
        <div>
            <div class='container'>
                <div class='row'>
                    <!-- <div class='col'></div> -->
                    <h3 v-if='error' style='color:#CEA68C; font-family: "Patua One", cursive;' class='col d-flex justify-content-center animate__animated animate__backInUp pt-4'>{{error}}</h3>
                    <!-- <div v-else class='col'><h3 class='pt-3' style='color:#CEA68C; font-family: "Patua One", cursive;'>Thank you for choosing Cheetah Express. Please hold on while we process your order.</h3></div> -->
                    <!-- <div class='col'></div> -->
                </div>

                <div v-if='loading' class='row'>
        
                    <div id="loader"></div>
                                        
                </div>
                
                <div class="container-fluid">
                    <div class="row">
                        <div class='col mx-auto'></div>
                        <div class='col d-flex justify-content-center smx-auto loader'></div>
                        <div class='col mx-auto'></div>
                    </div>
                </div>
            </div>
            <div class="container-fluid" v-if='successfulPayment'>
                <div class="row">
                    <!-- <div class='col mx-auto'></div> -->
                    <h3 style='color:#CEA68C; font-family: "Patua One", cursive;' class='col d-flex justify-content-center animate__animated animate__backInUp pt-4'>Thank you for placing an order! Click on View Deliveries to view your orders.</h3>
                    <!-- <div class='col mx-auto'></div> -->
                </div>
            </div>      
        </div>
    </div>

<script>
    // access sessionStorage to get the delivery data
    // delivery_data = JSON.parse(sessionStorage.getItem("delivery_data"));
    // // retrieve the Customer ID 
    // account_details = JSON.parse(sessionStorage.getItem("account_details"));
    // if (account_details.account_type == "customer"){
    //     customer_ID = account_details.customer_ID;
    // }
    // else {
    //     console.log("Delivery order failed to be created.")
    // }


    // var serviceURL = "http://localhost:4242/checkout_session/" + session_id;
    
    // processOrder as the serviceURL, temporary port: 5100
    
    // console.log(serviceURL);
    var app = new Vue({
        el: '#app',
        data:{
            successfulPayment: false,
            error: false,
            loading: true

        },
        mounted: function(){
            this.placeOrder()
        },
        
        methods:{
            placeOrder: function(){

                // retreives the session ID from the URL
                let params = new URLSearchParams(location.search);
                let session_id = params.get('session_id');
                console.log(session_id);

                delivery_data = JSON.parse(sessionStorage.getItem("delivery_data"));
                // retrieve the Customer ID 
                account_details = JSON.parse(sessionStorage.getItem("account_details"));
                // console.log(account_details)
                if (account_details.account_type == "customer"){
                    customer_ID = account_details.customer_ID;
                }
                else {
                    console.log("Delivery order failed to be created.")
                }


                var serviceURL = "http://localhost:5100/process_order";
                const details = {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        "session_id": session_id,
                        "delivery_data": delivery_data
                    })
                };

                fetch(serviceURL + "/" + String(customer_ID), details)
                    .then(response => response.json())
                    // console.log(response)
                    .then(data => {
                        // console.log(response)
                        console.log(data)
                        if(data.code >= 500){
                            this.error = "An error has occurred while processing your order. Please try again.";
                            this.loading = false;
                            
                        } else {
                            this.successfulPayment = true;
                            this.loading = false;
                        }
                            // console.log("hello")
                        
                    })
                    .catch(error=>{
                        console.log("Error:", error);
                        
                    })
            }}})







//                 $(async () => {
//         try {
//             const response = await fetch (serviceURL + "/" + String(customer_ID), { 
//                     method: 'POST',
//                     headers: {
//                         'Content-Type': 'application/json',
//                     },
//                     body: JSON.stringify({
//                         "session_id": session_id,
//                         "delivery_data": delivery_data
//                     })
                
//                 });
//             const data = await response.json();
//             if (response.ok){
//                 processOrderData = data;
//                 console.log(processOrderData);
//                 alert("Your order has been successfully created! :D")
//             }
//             else {
//                 console.log("There is an error in retrieving the payment data: Error " + response.status);
//             }
//         } 
//         catch(error) {
//             console.log("Error: ", error);
//         }
//     });
// }}})
    

    // invoke ProcessOrder (with payment session id & delivery_data)
    // $(async () => {
    //     try {
    //         const response = await fetch (serviceURL + "/" + String(customer_ID), { 
    //                 method: 'POST',
    //                 headers: {
    //                     'Content-Type': 'application/json',
    //                 },
    //                 body: JSON.stringify({
    //                     "session_id": session_id,
    //                     "delivery_data": delivery_data
    //                 })
                
    //             });
    //         const data = await response.json();
    //         if (response.ok){
    //             processOrderData = data;
    //             console.log(processOrderData);
    //             alert("Your order has been successfully created! :D")
    //         }
    //         else {
    //             console.log("There is an error in retrieving the payment data: Error " + response.status);
    //         }
    //     } 
    //     catch(error) {
    //         console.log("Error: ", error);
    //     }
    // });


    // $(async () => {
    //     try {
    //         const response = await fetch (
    //             serviceURL, { method: 'GET' }
    //         );
    //         const data = await response.json();
    //         if (response.ok){
    //             payment_data = data;
    //             console.log(payment_data);
    //         }
    //         else {
    //             console.log("There is an error in retrieving the payment data: Error " + response.status);
    //         }
    //     } 
    //     catch(error) {
    //         console.log("Error: ", error);
    //     }
    // });


    // fetch(url, {
    //     method: "GET"
    // })
    // .then(function(response){
    //     data = response.json();
    //     console.log(data);
    //     return data;
    // })
    // .catch(function(error){
    //     console.log("Error:", error);
    // })

</script>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>